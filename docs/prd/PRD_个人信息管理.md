# PRD: 个人信息管理

## 文档信息

- **功能点 ID**: VL-USR-002
- **产品模块**: 用户管理
- **创建日期**: 2025-01-15
- **创建人**: 产品团队
- **当前版本**: v1.0
- **最后更新**: 2025-01-15
- **文档状态**: 待评审

## 1. 背景与目标 (Background & Objectives)

### 1.1 业务背景

用户登录系统后,需要能够查看和修改自己的个人信息,包括基本资料和密码修改。当前系统缺少个人信息管理功能,用户无法自助更新个人资料,只能联系管理员进行修改,效率低下且用户体验差。

### 1.2 目标用户

- **主要用户**: 所有登录用户(管理员、运营人员、普通用户)
- **次要用户**: 无

### 1.3 核心目标

1. **自助管理**: 用户可以自主查看和修改个人信息,无需联系管理员,提升用户自主性 100%
2. **安全性**: 密码修改需要旧密码验证,确保账户安全性,防止未授权修改
3. **便捷性**: 在任意页面通过顶部导航快速访问个人信息,操作步骤 ≤ 2 步

## 2. 用户故事 (User Stories)

### Story 1: 查看个人信息

- **作为** 登录用户
- **我想要** 快速查看我的个人信息(姓名、邮箱、手机号、角色等)
- **以便于** 确认我的账户信息是否正确
- **优先级**: 🔴 P0

**验收条件**:
- 点击顶部用户头像后,可在下拉菜单中选择"个人信息"
- 弹出个人信息详情弹框,显示所有个人资料
- 显示字段包括:姓名、用户名、邮箱、手机号、角色、部门、创建时间、最后登录时间

### Story 2: 编辑个人信息

- **作为** 登录用户
- **我想要** 修改我的个人信息(姓名、邮箱、手机号等)
- **以便于** 保持个人资料的准确性
- **优先级**: 🔴 P0

**验收条件**:
- 在个人信息详情弹框中,点击"编辑"按钮切换为编辑模式
- 可编辑字段包括:姓名、邮箱、手机号
- 不可编辑字段:用户名、角色、部门、创建时间
- 提交后保存成功,并刷新显示最新数据

### Story 3: 修改密码

- **作为** 登录用户
- **我想要** 修改我的登录密码
- **以便于** 定期更换密码,保障账户安全
- **优先级**: 🔴 P0

**验收条件**:
- 点击顶部用户头像后,可在下拉菜单中选择"修改密码"
- 弹出修改密码弹框
- 需要填写:旧密码、新密码、确认新密码
- 旧密码验证通过后才能修改成功
- 修改成功后自动退出登录,需要用新密码重新登录

## 3. 功能需求 (Functional Requirements)

### 3.1 功能点 1: 查看个人信息详情

- **功能描述**: 用户可以通过顶部导航查看自己的个人信息详情
- **输入**: 无(系统自动加载当前登录用户信息)
- **处理**: 
  - 调用 API 获取当前用户的详细信息
  - 在 Modal 弹框中以只读形式展示
  - 使用 Descriptions 组件展示字段
- **输出**: 显示包含所有个人信息字段的详情弹框
- **异常处理**: 
  - 加载失败:提示"加载失败,请稍后重试"
  - 网络超时:显示超时提示

### 3.2 功能点 2: 编辑个人信息

- **功能描述**: 用户可以编辑自己的部分个人信息
- **输入**: 
  - 姓名(必填,2-20 个字符)
  - 邮箱(必填,邮箱格式)
  - 手机号(必填,11 位数字)
- **处理**:
  - 在同一个 Modal 中切换为编辑模式
  - 使用 Form 组件实现表单编辑
  - 实时校验字段格式
  - 提交时调用更新 API
- **输出**:
  - 保存成功:提示"保存成功",刷新详情显示
  - 保存失败:显示具体错误信息
- **异常处理**:
  - 邮箱格式错误:提示"请输入正确的邮箱地址"
  - 手机号格式错误:提示"请输入11位手机号"
  - 保存失败:提示具体错误原因

### 3.3 功能点 3: 修改密码

- **功能描述**: 用户可以修改自己的登录密码
- **输入**: 
  - 旧密码(必填,6-20 个字符)
  - 新密码(必填,6-20 个字符,需包含字母和数字)
  - 确认新密码(必填,需与新密码一致)
- **处理**:
  - 独立的修改密码 Modal 弹框
  - 校验旧密码是否正确
  - 校验新密码格式
  - 校验两次新密码输入是否一致
  - 提交后调用修改密码 API
  - 修改成功后自动退出登录
- **输出**:
  - 修改成功:提示"密码修改成功,请重新登录",自动跳转登录页
  - 修改失败:显示具体错误信息
- **异常处理**:
  - 旧密码错误:提示"旧密码输入错误"
  - 新密码格式不符:提示"密码需包含字母和数字,长度6-20位"
  - 两次密码不一致:提示"两次输入的密码不一致"

## 4. 交互流程 (User Flow)

### 4.1 主流程 - 查看个人信息

1. 用户点击顶部导航右侧的用户头像
2. 系统显示下拉菜单
3. 用户点击"个人信息"菜单项
4. 系统打开个人信息详情 Modal 弹框
5. 系统调用 API 加载用户信息
6. 系统在弹框中展示用户信息(只读模式)
7. 用户查看完毕后点击"关闭"或"取消"按钮
8. 系统关闭弹框

### 4.2 主流程 - 编辑个人信息

1. 在个人信息详情弹框中,用户点击"编辑"按钮
2. 系统切换为编辑模式,表单字段变为可编辑状态
3. 用户修改可编辑字段(姓名、邮箱、手机号)
4. 用户点击"保存"按钮
5. 系统校验表单数据
   - 校验通过 → 进入步骤 6
   - 校验失败 → 显示错误提示,返回步骤 3
6. 系统调用更新 API
7. API 返回结果
   - 成功 → 提示"保存成功",刷新详情显示,切换回只读模式
   - 失败 → 显示错误提示,保持编辑模式
8. 用户可以继续编辑或关闭弹框

### 4.3 主流程 - 修改密码

1. 用户点击顶部导航右侧的用户头像
2. 系统显示下拉菜单
3. 用户点击"修改密码"菜单项
4. 系统打开修改密码 Modal 弹框
5. 用户填写:旧密码、新密码、确认新密码
6. 用户点击"确定"按钮
7. 系统校验表单数据
   - 校验通过 → 进入步骤 8
   - 校验失败 → 显示错误提示,返回步骤 5
8. 系统调用修改密码 API
9. API 返回结果
   - 成功 → 提示"密码修改成功,请重新登录",2 秒后自动跳转到登录页
   - 失败 → 显示错误提示(如"旧密码错误"),保持弹框打开
10. 用户在登录页使用新密码登录

### 4.4 异常流程

#### 场景1: 数据加载失败

- **触发条件**: 调用获取用户信息 API 失败
- **系统行为**:
  - 弹框中显示错误提示:"加载失败,请稍后重试"
  - 提供"重新加载"按钮
- **用户操作**: 点击"重新加载"或关闭弹框

#### 场景2: 表单校验失败

- **触发条件**: 用户输入的数据不符合校验规则
- **系统行为**:
  - 在对应字段下方显示红色错误提示
  - "保存"或"确定"按钮保持可用
  - 弹框保持打开状态
- **用户操作**: 修改错误字段后重新提交

#### 场景3: 修改密码时旧密码错误

- **触发条件**: API 返回旧密码验证失败
- **系统行为**:
  - 显示错误提示:"旧密码输入错误,请重新输入"
  - 清空旧密码输入框
  - 保持弹框打开
- **用户操作**: 重新输入旧密码并提交

#### 场景4: 网络请求超时

- **触发条件**: API 调用超时(> 10 秒)
- **系统行为**:
  - 显示提示:"网络超时,请检查网络连接后重试"
  - 保持用户已填写的数据
- **用户操作**: 检查网络后点击"重试"

### 4.5 流程图 - 查看与编辑个人信息

```
[开始] → [点击用户头像]
    ↓
[显示下拉菜单] → [点击"个人信息"]
    ↓
[打开详情弹框] → [加载数据]
    ↓
[显示只读详情]
    ↓
  [用户操作?]
    ├─ [点击"关闭"] → [关闭弹框] → [结束]
    └─ [点击"编辑"] → [切换为编辑模式]
         ↓
       [修改字段]
         ↓
       [点击"保存"] → [校验数据]
         ↓
       [是否通过?]
         ├─ 是 → [调用API] → [成功?]
         │                    ├─ 是 → [提示成功] → [刷新数据] → [切换回只读模式]
         │                    └─ 否 → [显示错误] → [返回编辑模式]
         └─ 否 → [显示校验错误] → [返回编辑模式]
```

### 4.6 流程图 - 修改密码

```
[开始] → [点击用户头像]
    ↓
[显示下拉菜单] → [点击"修改密码"]
    ↓
[打开修改密码弹框]
    ↓
[填写密码表单]
    ↓
[点击"确定"] → [校验表单]
    ↓
  [是否通过?]
    ├─ 是 → [调用修改密码API] → [成功?]
    │                          ├─ 是 → [提示成功] → [2秒后自动跳转] → [跳转到登录页] → [结束]
    │                          └─ 否 → [显示错误(如旧密码错误)] → [返回表单]
    └─ 否 → [显示校验错误] → [返回表单]
```

## 5. UI 原型 (UI Wireframes)

### 5.1 页面结构

- **页面类型**: Modal 弹框(详情 + 编辑一体)
- **布局方式**: Descriptions(只读模式) / Form(编辑模式)
- **核心组件**: Modal / Descriptions / Form / Input / Button

### 5.2 个人信息详情字段定义

| 字段名称 | 字段类型 | 是否可编辑 | 校验规则 | 默认值 | 说明 |
|---------|---------|-----------|---------|--------|------|
| 姓名 | Input | ✅ 是 | 2-20个字符 | - | 用户真实姓名 |
| 用户名 | Display | ❌ 否 | - | - | 登录账号,不可修改 |
| 邮箱 | Input | ✅ 是 | 邮箱格式 | - | 联系邮箱 |
| 手机号 | Input | ✅ 是 | 11位数字 | - | 联系电话 |
| 角色 | Display | ❌ 否 | - | - | 用户角色(管理员/运营/用户) |
| 部门 | Display | ❌ 否 | - | - | 所属部门 |
| 创建时间 | Display | ❌ 否 | - | - | 账户创建时间 |
| 最后登录时间 | Display | ❌ 否 | - | - | 最近一次登录时间 |

### 5.3 修改密码字段定义

| 字段名称 | 字段类型 | 是否必填 | 校验规则 | 说明 |
|---------|---------|---------|---------|------|
| 旧密码 | Input.Password | ✅ 是 | 6-20个字符 | 当前密码 |
| 新密码 | Input.Password | ✅ 是 | 6-20个字符,包含字母和数字 | 新密码 |
| 确认新密码 | Input.Password | ✅ 是 | 需与新密码一致 | 再次输入新密码 |

### 5.4 按钮与操作

**个人信息弹框**:

| 按钮名称 | 位置 | 样式 | 显示条件 | 操作说明 |
|---------|------|------|---------|---------|
| 编辑 | 弹框底部左侧 | Default | 只读模式 | 切换为编辑模式 |
| 关闭 | 弹框底部右侧 | Default | 只读模式 | 关闭弹框 |
| 保存 | 弹框底部右侧 | Primary | 编辑模式 | 保存修改并切换回只读模式 |
| 取消 | 弹框底部右侧 | Default | 编辑模式 | 取消编辑,切换回只读模式 |

**修改密码弹框**:

| 按钮名称 | 位置 | 样式 | 操作说明 |
|---------|------|------|---------|
| 确定 | 弹框底部右侧 | Primary | 提交修改密码请求 |
| 取消 | 弹框底部右侧 | Default | 关闭弹框 |

### 5.5 原型链接

- **本地代码路径**: 
  - `src/pages/user/profile/ProfileModal.tsx` (个人信息弹框)
  - `src/pages/user/profile/PasswordModal.tsx` (修改密码弹框)
  - `src/layouts/index.tsx` (集成到顶部导航)
- **相关组件**: 
  - `src/types/profile.ts` (类型定义)
  - `src/services/profile.ts` (API 服务)

## 6. 数据定义 (Data Schema)

### 6.1 API 接口

#### 获取当前用户信息

| 项目 | 内容 |
|-----|------|
| 接口路径 | GET /api/user/profile |
| 请求参数 | 无(从 token 中获取用户 ID) |
| 响应数据 | `{ code: number, message: string, data: UserProfile }` |
| 错误码 | 200: 成功, 401: 未登录, 500: 服务器错误 |

#### 更新个人信息

| 项目 | 内容 |
|-----|------|
| 接口路径 | PUT /api/user/profile |
| 请求参数 | `{ name: string, email: string, phone: string }` |
| 响应数据 | `{ code: number, message: string, data: UserProfile }` |
| 错误码 | 200: 成功, 400: 参数错误, 401: 未登录, 409: 邮箱已被使用 |

#### 修改密码

| 项目 | 内容 |
|-----|------|
| 接口路径 | POST /api/user/change-password |
| 请求参数 | `{ oldPassword: string, newPassword: string }` |
| 响应数据 | `{ code: number, message: string }` |
| 错误码 | 200: 成功, 400: 旧密码错误, 401: 未登录, 500: 服务器错误 |

### 6.2 数据模型

```typescript
// 用户个人信息模型
export interface UserProfile {
  id: string;                    // 用户 ID
  username: string;              // 用户名(登录账号)
  name: string;                  // 姓名
  email: string;                 // 邮箱
  phone: string;                 // 手机号
  role: UserRole;                // 角色
  roleName: string;              // 角色名称(中文)
  department?: string;           // 部门
  avatar?: string;               // 头像 URL
  createdAt: string;             // 创建时间(ISO 8601)
  lastLoginAt?: string;          // 最后登录时间(ISO 8601)
}

// 用户角色枚举
export enum UserRole {
  Admin = 'admin',          // 管理员
  Operator = 'operator',    // 运营人员
  User = 'user',            // 普通用户
}

// 更新个人信息参数
export interface UpdateProfileParams {
  name: string;      // 姓名
  email: string;     // 邮箱
  phone: string;     // 手机号
}

// 修改密码参数
export interface ChangePasswordParams {
  oldPassword: string;    // 旧密码
  newPassword: string;    // 新密码
}

// API 通用响应
export interface ApiResponse<T = any> {
  code: number;           // 响应码
  message: string;        // 响应消息
  data?: T;               // 响应数据
}
```

## 7. 业务规则 (Business Rules)

### 7.1 校验规则

1. **姓名**:
   - 长度: 2-20 个字符
   - 格式: 支持中文、英文、空格
   - 必填: 是

2. **邮箱**:
   - 格式: 符合标准邮箱格式(如 user@example.com)
   - 唯一性: 同一租户下邮箱不可重复
   - 必填: 是

3. **手机号**:
   - 格式: 11 位数字
   - 必填: 是

4. **旧密码**:
   - 长度: 6-20 个字符
   - 验证: 需要与数据库中存储的密码一致
   - 必填: 是

5. **新密码**:
   - 长度: 6-20 个字符
   - 复杂度: 必须包含字母和数字
   - 不能与旧密码相同
   - 必填: 是

6. **确认新密码**:
   - 必须与新密码完全一致
   - 必填: 是

### 7.2 权限规则

所有登录用户都可以:
- ✅ 查看自己的个人信息
- ✅ 编辑自己的个人信息(姓名、邮箱、手机号)
- ✅ 修改自己的密码

限制:
- ❌ 用户不能修改自己的用户名
- ❌ 用户不能修改自己的角色
- ❌ 用户不能修改自己的部门
- ❌ 用户不能查看或修改他人的个人信息

### 7.3 业务逻辑

1. **数据回显**:
   - 打开个人信息弹框时,自动加载当前登录用户的信息
   - 切换到编辑模式时,表单自动回填当前数据

2. **编辑模式切换**:
   - 点击"编辑"按钮:从只读模式切换到编辑模式
   - 点击"取消"按钮:从编辑模式切换回只读模式,丢弃未保存的修改
   - 点击"保存"按钮:保存成功后自动切换回只读模式

3. **密码修改后处理**:
   - 密码修改成功后,清除本地登录凭证(token)
   - 显示成功提示,2 秒后自动跳转到登录页
   - 用户需要使用新密码重新登录

4. **数据保护**:
   - 密码输入框使用 Input.Password 组件,隐藏明文显示
   - 旧密码不返回给前端,编辑时不显示

### 7.4 并发控制

- 个人信息修改不涉及并发问题(用户只能修改自己的信息)
- 如果用户在多个设备同时登录并修改信息,以最后一次提交为准

## 8. 非功能需求 (Non-Functional Requirements)

### 8.1 性能要求

- **数据加载时间**: < 1 秒
- **表单提交响应**: < 1 秒
- **密码修改响应**: < 2 秒

### 8.2 兼容性

- **浏览器**: Chrome 90+, Safari 14+, Edge 90+, Firefox 88+
- **屏幕分辨率**: ≥ 1366x768
- **移动端**: 暂不支持(后续版本考虑)

### 8.3 可用性

- **操作步骤**: 查看个人信息 ≤ 2 步,修改个人信息 ≤ 4 步
- **错误提示**: 必须清晰明确,并提供解决方案
- **加载反馈**: 所有异步操作必须有 loading 状态
- **成功反馈**: 操作成功后必须有明确提示

### 8.4 安全性

- **密码传输**: 密码字段必须加密传输(HTTPS)
- **密码存储**: 后端使用哈希算法存储密码,不存储明文
- **旧密码验证**: 修改密码必须验证旧密码
- **会话管理**: 密码修改后立即清除当前会话,要求重新登录
- **操作日志**: 记录所有个人信息修改和密码修改操作

## 9. 验收标准 (Acceptance Criteria)

### 9.1 功能验收

- [ ] 用户点击顶部用户头像,下拉菜单正确显示
- [ ] 点击"个人信息"菜单项,弹框正确打开
- [ ] 个人信息详情正确加载并显示所有字段
- [ ] 点击"编辑"按钮,正确切换到编辑模式
- [ ] 可编辑字段(姓名、邮箱、手机号)可以正常输入
- [ ] 不可编辑字段保持只读状态
- [ ] 表单校验规则正确(姓名长度、邮箱格式、手机号格式)
- [ ] 点击"保存"按钮,数据提交成功
- [ ] 保存成功后,弹框切换回只读模式并显示最新数据
- [ ] 点击"取消"按钮,丢弃未保存的修改并切换回只读模式
- [ ] 点击"修改密码"菜单项,修改密码弹框正确打开
- [ ] 密码输入框正确隐藏明文显示
- [ ] 旧密码验证正确(输入错误密码时提示错误)
- [ ] 新密码复杂度校验正确(需包含字母和数字)
- [ ] 两次新密码一致性校验正确
- [ ] 密码修改成功后,显示成功提示并自动跳转登录页
- [ ] 使用新密码可以正常登录

### 9.2 UI 验收

- [ ] 弹框宽度合适(详情弹框 600px,密码弹框 500px)
- [ ] 弹框标题清晰("个人信息"、"修改密码")
- [ ] 字段标签对齐,排版整齐
- [ ] 编辑模式下,表单布局合理
- [ ] 按钮位置正确(编辑/关闭/保存/取消)
- [ ] 按钮样式符合规范(Primary/Default/Danger)
- [ ] 错误提示样式正确(红色,字段下方)
- [ ] 成功提示样式正确(绿色,全局提示)
- [ ] Loading 状态正确显示

### 9.3 性能验收

- [ ] 个人信息加载时间 < 1 秒
- [ ] 表单提交响应时间 < 1 秒
- [ ] 密码修改响应时间 < 2 秒
- [ ] 无明显的页面卡顿

### 9.4 异常验收

- [ ] 网络异常时显示友好提示
- [ ] 旧密码错误时显示明确提示
- [ ] 邮箱已被使用时显示提示
- [ ] 表单校验失败时,弹框保持打开状态
- [ ] 数据加载失败时,提供重试机制

### 9.5 安全验收

- [ ] 密码输入框不显示明文
- [ ] 密码修改成功后自动退出登录
- [ ] 旧密码验证失败时,密码修改失败
- [ ] 所有请求通过 HTTPS 加密传输
- [ ] 操作日志正确记录

## 10. 变更记录 (Change Log)

| 版本号 | 日期 | 变更类型 | 变更内容 | 变更人 | 评审状态 |
|-------|------|---------|---------|--------|---------|
| v1.0  | 2025-01-15 | 新增 | 初始版本,定义个人信息查看、编辑、修改密码功能 | 产品团队 | 待评审 |

## 11. 附录 (Appendix)

### 11.1 相关文档

- **用户手册**: `docs/user-manual/user_manual_个人信息管理.md`
- **前端代码**: 
  - `src/pages/user/profile/ProfileModal.tsx`
  - `src/pages/user/profile/PasswordModal.tsx`
- **类型定义**: `src/types/profile.ts`
- **API 服务**: `src/services/profile.ts`

### 11.2 术语表

| 术语 | 英文 | 说明 |
|-----|------|------|
| 个人信息 | Profile | 用户的基本资料信息 |
| 密码 | Password | 用户登录凭证 |
| 会话 | Session | 用户登录后的有效期 |
| Token | Token | 用户身份认证令牌 |

### 11.3 参考资料

- Ant Design v4 Modal 组件文档: https://4x.ant.design/components/modal-cn/
- Ant Design v4 Form 组件文档: https://4x.ant.design/components/form-cn/
- Ant Design v4 Descriptions 组件文档: https://4x.ant.design/components/descriptions-cn/

---

**审核记录**

| 审核人 | 审核日期 | 审核意见 | 审核结果 |
|-------|---------|---------|---------|
| - | - | - | 待评审 |
